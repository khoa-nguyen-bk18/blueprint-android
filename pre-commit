#!/bin/bash
#
# BluePrint Android - Pre-commit Hook
# Enforces code quality rules before allowing commits
#
# Installation:
#   cp pre-commit .git/hooks/pre-commit
#   chmod +x .git/hooks/pre-commit
#

set -e

echo "üîç Running pre-commit checks..."

# Get list of staged Kotlin files
STAGED_KT_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.kt$' || true)

if [ -z "$STAGED_KT_FILES" ]; then
    echo "‚úÖ No Kotlin files to check"
    exit 0
fi

echo "üìã Checking ${STAGED_KT_FILES}"

# Rule 1: No !! (non-null assertion)
echo "üö´ Checking for !! usage..."
if git diff --cached --name-only --diff-filter=ACM | grep '\.kt$' | xargs grep -n '!!' 2>/dev/null; then
    echo "‚ùå COMMIT REJECTED: Found !! (non-null assertion operator)"
    echo "   Rule: No !! anywhere in the codebase"
    echo "   Fix: Use safe calls (?.), let, require(), or check() instead"
    exit 1
fi

# Rule 2: No GlobalScope
echo "üö´ Checking for GlobalScope usage..."
if git diff --cached --name-only --diff-filter=ACM | grep '\.kt$' | xargs grep -n 'GlobalScope' 2>/dev/null; then
    echo "‚ùå COMMIT REJECTED: Found GlobalScope usage"
    echo "   Rule: No GlobalScope allowed"
    echo "   Fix: Use viewModelScope, lifecycleScope, or proper coroutine scopes"
    exit 1
fi

# Rule 3: No println or printStackTrace
echo "üö´ Checking for println/printStackTrace..."
if git diff --cached --name-only --diff-filter=ACM | grep '\.kt$' | xargs grep -E -n 'println\(|printStackTrace\(' 2>/dev/null; then
    echo "‚ùå COMMIT REJECTED: Found println or printStackTrace"
    echo "   Rule: No println or printStackTrace allowed"
    echo "   Fix: Use proper logging (Timber, Logcat wrapper, or remove debug code)"
    exit 1
fi

# Rule 4: No hardcoded strings in Text() composables (simplified check)
echo "üö´ Checking for hardcoded strings..."
if git diff --cached --name-only --diff-filter=ACM | grep '\.kt$' | xargs grep -E -n 'Text\("' 2>/dev/null | grep -v 'stringResource\|BuildConfig\|//' | head -5; then
    echo "‚ö†Ô∏è  WARNING: Possible hardcoded strings in Text() composables"
    echo "   Rule: Use stringResource(R.string.xxx) for user-visible text"
    echo "   Continuing anyway - but please review!"
fi

# Rule 5: Run spotlessCheck (formatting)
echo "üíÖ Running Spotless formatting check..."
if ! ./gradlew spotlessCheck --quiet 2>&1; then
    echo "‚ùå COMMIT REJECTED: Code formatting issues detected"
    echo "   Fix: Run './gradlew spotlessApply' to auto-format your code"
    exit 1
fi

echo "‚úÖ All pre-commit checks passed!"
exit 0
